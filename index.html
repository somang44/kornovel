<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>K-–ù–æ–≤–µ–ª–ª—ã</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111318;
      --muted:#6b7280;
      --border:rgba(17,19,24,.10);
      --accent:#e56a84;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --r16:16px;
    }
    body.dark{
      --bg:#0f1115;
      --card:#161a22;
      --text:#f3f4f6;
      --muted:#9ca3af;
      --border:#262b36;
      --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      background:var(--bg);
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:10;
    }
    .brand{font-weight:900; letter-spacing:.2px}
    .btn{
      border:none;
      background:var(--accent);
      color:white;
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .wrap{max-width:980px; margin:0 auto; padding-bottom:78px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r16);
      box-shadow:var(--shadow);
      padding:16px;
      margin:14px;
    }
    .novel{
      cursor:pointer;
      transition:transform .08s ease;
    }
    .novel:hover{transform:translateY(-1px)}
    .muted{color:var(--muted)}
    .coverRow{display:flex; gap:14px; align-items:flex-start;}
    .cover{
      width:84px; height:120px; border-radius:14px; object-fit:cover;
      border:1px solid var(--border);
      background:rgba(0,0,0,.04);
      flex:0 0 auto;
    }
    .title{font-weight:900; font-size:20px; margin:0 0 6px}
    .genres{font-size:13px; color:var(--muted)}
    .hidden{display:none}
    .chapList{display:flex; flex-direction:column; gap:10px; margin-top:12px;}
    .chapter{
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      cursor:pointer;
      background:transparent;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .chapter.locked{opacity:.55}
    .readerTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .back{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .readerTitle{font-weight:900; font-size:22px; margin:0 0 6px}
    .readerMeta{color:var(--muted); font-size:13px; margin-bottom:10px}
    .readerText{
      white-space:pre-wrap;         /* –í–ê–ñ–ù–û: –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º */
      line-height:1.75;
      font-size:16px;
    }

    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--card);
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-around;
      padding:10px 8px;
      z-index:20;
    }
    .tab{
      cursor:pointer;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      font-weight:800;
      color:var(--text);
      min-width:140px;
      text-align:center;
    }
    .rowBtns{
      display:flex; justify-content:space-between; gap:10px; margin-top:14px;
    }
    .mini{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
      flex:1;
    }
    .like{
      border:none;
      background:var(--accent);
      color:white;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      flex:1;
    }
  </style>
</head>

<body>
<header class="wrap">
  <div class="brand">K-–ù–æ–≤–µ–ª–ª—ã</div>
  <button class="btn" onclick="toggleTheme()">üåó</button>
</header>

<div class="wrap">

  <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
  <div id="library">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div class="title" style="margin:0;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
          <div class="muted" id="libHint">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>
        </div>
        <button class="back" onclick="reloadAll()" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
      </div>
    </div>
    <div id="novelCards"></div>
  </div>

  <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–û–í–ï–õ–õ–´ -->
  <div id="novelPage" class="hidden">
    <div class="card">
      <div class="readerTop">
        <button class="back" onclick="show('library')">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="back" onclick="reloadAll()">‚Üª</button>
      </div>

      <div class="coverRow">
        <img id="novelCover" class="cover" alt="">
        <div>
          <h2 id="novelTitle" class="title"></h2>
          <div id="novelGenres" class="genres"></div>
          <p id="novelDesc" class="muted" style="margin:10px 0 0;"></p>
        </div>
      </div>

      <div id="chapters" class="chapList"></div>
    </div>
  </div>

  <!-- –ß–ò–¢–ê–õ–ö–ê -->
  <div id="reader" class="hidden">
    <div class="card">
      <div class="readerTop">
        <button class="back" onclick="backToNovel()">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="back" onclick="reloadAll()">‚Üª</button>
      </div>

      <h2 id="chapterTitle" class="readerTitle"></h2>
      <div id="chapterMeta" class="readerMeta"></div>
      <div id="chapterText" class="readerText"></div>

      <div class="rowBtns">
        <button class="mini" onclick="prevChapter()">‚Üê –ü—Ä–µ–¥.</button>
        <button class="mini" onclick="nextChapter()">–°–ª–µ–¥. ‚Üí</button>
        <button class="like" onclick="like()">‚ù§Ô∏è –õ–∞–π–∫</button>
      </div>
    </div>
  </div>

  <!-- –ü–†–û–§–ò–õ–¨ -->
  <div id="profile" class="hidden">
    <div class="card">
      <h2 class="title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <p>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≥–ª–∞–≤: <b id="statRead">0</b></p>
      <p>–õ–∞–π–∫–æ–≤: <b id="statLikes">0</b></p>
      <p class="muted" style="margin-top:10px;">–ï—Å–ª–∏ ‚Äú–ù–æ–≤–µ–ª–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã‚Äù ‚Äî –æ–±—ã—á–Ω–æ —ç—Ç–æ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ –∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏.</p>
    </div>
  </div>

</div>

<div class="bottom">
  <div class="tab" onclick="show('library')">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
  <div class="tab" onclick="show('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
</div>

<script>
/* ===================== –ù–ê–°–¢–†–û–ô–ö–ò ===================== */
const SHEET_ID = "1Cn6zEDo5nfoihe_p0bJxU6WICuhLN38NcWqyKOD7rA0";
const SHEETS = { novels:"novels", chapters:"chapters" }; // –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤ –≤–Ω–∏–∑—É

const tg = window.Telegram?.WebApp;
tg?.expand();

/* ===================== –°–û–°–¢–û–Ø–ù–ò–ï ===================== */
let DATA = {};
let currentNovelId = null;
let currentChapterIndex = 0;

let readCount = Number(localStorage.getItem("read")||0);
let likes = Number(localStorage.getItem("likes")||0);

/* ===================== UI ===================== */
function show(id){
  ["library","novelPage","reader","profile"].forEach(x=>{
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("statRead").textContent = readCount;
  document.getElementById("statLikes").textContent = likes;
}

function toggleTheme(){
  document.body.classList.toggle("dark");
}

function like(){
  likes++;
  localStorage.setItem("likes", likes);
  document.getElementById("statLikes").textContent = likes;
  tg?.HapticFeedback?.impactOccurred("light");
}

function backToNovel(){
  if(currentNovelId) openNovel(currentNovelId);
  else show("library");
}

/* ===================== GVIZ –ó–ê–ì–†–£–ó–ö–ê ===================== */
function gvizUrl(sheetName){
  // headers=1 –ø–æ–º–æ–≥–∞–µ—Ç, –Ω–æ –º—ã –µ—â—ë –∏ –≤—Ä—É—á–Ω—É—é –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(sheetName)}`;
}

async function fetchGviz(sheetName){
  const res = await fetch(gvizUrl(sheetName), { cache: "no-store" });
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
  const cols = (json.table.cols || []).map(c => (c.label||"").trim());
  const rows = (json.table.rows || []).map(r => (r.c||[]).map(cell => cell ? (cell.v ?? "") : ""));
  return { cols, rows };
}

function normalizeHeaders(cols, rows){
  // –ï—Å–ª–∏ labels –ø—É—Å—Ç—ã–µ (–±—ã–≤–∞–µ—Ç!), –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∏
  const labelsEmpty = cols.every(c => !String(c||"").trim());
  if(!labelsEmpty) return { cols, rows };

  if(rows.length === 0) return { cols: [], rows: [] };

  const headerRow = rows[0].map(v => String(v||"").trim());
  const dataRows = rows.slice(1);
  return { cols: headerRow, rows: dataRows };
}

function toObjects(cols, rows){
  return rows
    .filter(r => r.some(v => String(v).trim() !== ""))
    .map(r => {
      const obj = {};
      cols.forEach((k,i)=> obj[String(k||"").trim()] = r[i]);
      return obj;
    });
}

/* ===================== –°–ö–õ–ï–ô–ö–ê –ì–õ–ê–í ===================== */
function buildChaptersWithGlue(cols, rows){
  // –æ–∂–∏–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏: id | novel_id | title | text | is_paid | order
  const idx = {};
  cols.forEach((k,i)=> idx[String(k||"").trim()] = i);

  const get = (row, key) => row[idx[key]] ?? "";

  const out = [];
  let current = null;

  for(const row of rows){
    const id = String(get(row,"id")||"").trim();
    const novel_id = String(get(row,"novel_id")||"").trim();
    const title = String(get(row,"title")||"").trim();
    const text = String(get(row,"text")||"");
    const is_paid = String(get(row,"is_paid")||"").toUpperCase()==="TRUE";
    const orderRaw = get(row,"order");

    const hasStart = (id || novel_id || title);         // –Ω–æ–≤–∞—è –≥–ª–∞–≤–∞
    const hasText = String(text||"").trim() !== "";

    if(hasStart){
      current = {
        id,
        novel_id,
        title: title || "–ì–ª–∞–≤–∞",
        text: hasText ? text : "",
        paid: is_paid,
        order: orderRaw ? Number(orderRaw) : 0
      };
      out.push(current);
      continue;
    }

    // –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (–ø—É—Å—Ç—ã–µ A/B/C, –Ω–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç) ‚Äî —Å–∫–ª–µ–∏–≤–∞–µ–º
    if(current && hasText){
      current.text += (current.text.trim() ? "\n\n" : "") + text;
    }
  }
  return out;
}

/* ===================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===================== */
async function loadData(){
  // novels
  let novelsRaw = await fetchGviz(SHEETS.novels);
  novelsRaw = normalizeHeaders(novelsRaw.cols, novelsRaw.rows);
  const novels = toObjects(novelsRaw.cols, novelsRaw.rows);

  // chapters (—Å –∫–ª–µ–µ–º)
  let chaptersRaw = await fetchGviz(SHEETS.chapters);
  chaptersRaw = normalizeHeaders(chaptersRaw.cols, chaptersRaw.rows);
  const gluedChapters = buildChaptersWithGlue(chaptersRaw.cols, chaptersRaw.rows);

  // —Å–æ–±–µ—Ä—ë–º –ø–æ novel_id
  const byNovel = {};
  for(const ch of gluedChapters){
    const nid = String(ch.novel_id||"").trim();
    if(!nid) continue;
    if(!byNovel[nid]) byNovel[nid]=[];
    byNovel[nid].push({
      title: String(ch.title||"").trim() || "–ì–ª–∞–≤–∞",
      text: String(ch.text||""),
      paid: !!ch.paid,
      order: ch.order ? Number(ch.order) : 0,
    });
  }
  Object.keys(byNovel).forEach(nid=>{
    byNovel[nid].sort((a,b)=>(a.order||0)-(b.order||0));
  });

  // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π DATA
  const result = {};
  for(const n of novels){
    const id = String(n.id||"").trim();
    if(!id) continue;

    result[id] = {
      title: String(n.title||"").trim() || "–ù–æ–≤–µ–ª–ª–∞",
      desc: String(n.description||"").trim(),
      cover: String(n.cover||"").trim(),
      genres: String(n.genres||"").trim(),
      chapters: byNovel[id] || [],
    };
  }
  DATA = result;
}

/* ===================== –†–ï–ù–î–ï–† ===================== */
function renderLibrary(){
  const novelCards = document.getElementById("novelCards");
  novelCards.innerHTML = "";

  const keys = Object.keys(DATA || {});
  if(keys.length === 0){
    document.getElementById("libHint").textContent =
      "–ù–æ–≤–µ–ª–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å –ª–∏—Å—Ç novels –∏ –¥–æ—Å—Ç—É–ø ¬´–í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª (–∏ —á—Ç–æ –ª–∏—Å—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è exactly: novels).";
    return;
  }
  document.getElementById("libHint").textContent = `–ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–µ–ª–ª: ${keys.length}`;

  keys.forEach(id=>{
    const n = DATA[id];
    const div = document.createElement("div");
    div.className = "card novel";
    div.onclick = ()=>openNovel(id);

    div.innerHTML = `
      <div class="coverRow">
        <img class="cover" src="${escapeHtml(n.cover||"")}" alt="">
        <div>
          <div class="title" style="margin:0 0 6px">${escapeHtml(n.title)}</div>
          <div class="genres">${escapeHtml(n.genres||"")}${n.chapters?.length ? ` ¬∑ ${n.chapters.length} –≥–ª–∞–≤` : ""}</div>
          <div class="muted" style="margin-top:8px">${escapeHtml(n.desc||"")}</div>
        </div>
      </div>
    `;
    novelCards.appendChild(div);
  });
}

function openNovel(id){
  currentNovelId = id;
  const n = DATA[id];
  show("novelPage");

  document.getElementById("novelTitle").textContent = n.title;
  document.getElementById("novelDesc").textContent = n.desc || "";
  document.getElementById("novelGenres").textContent = (n.genres||"");
  const coverEl = document.getElementById("novelCover");
  coverEl.src = n.cover || "";
  coverEl.style.display = n.cover ? "block" : "none";

  const chaptersEl = document.getElementById("chapters");
  chaptersEl.innerHTML = "";

  if(!n.chapters || n.chapters.length === 0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.marginTop = "12px";
    empty.textContent = "–ì–ª–∞–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ó–∞–ø–æ–ª–Ω–∏ –ª–∏—Å—Ç chapters.";
    chaptersEl.appendChild(empty);
    return;
  }

  n.chapters.forEach((c,i)=>{
    const row = document.createElement("div");
    row.className = "chapter" + (c.paid ? " locked" : "");
    row.innerHTML = `
      <div style="font-weight:800">${escapeHtml(c.title)} ${c.paid ? "üîí" : ""}</div>
      <div class="muted" style="font-size:12px">#${i+1}</div>
    `;
    row.onclick = ()=>openChapter(id,i);
    chaptersEl.appendChild(row);
  });
}

function openChapter(novelId, i){
  const n = DATA[novelId];
  const ch = n.chapters[i];

  if(ch.paid){
    alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç Telegram Payments üí≥");
    return;
  }

  currentNovelId = novelId;
  currentChapterIndex = i;

  show("reader");
  document.getElementById("chapterTitle").textContent = ch.title;
  document.getElementById("chapterMeta").textContent = `${n.title} ¬∑ –ì–ª–∞–≤–∞ ${i+1} –∏–∑ ${n.chapters.length}`;
  document.getElementById("chapterText").textContent = ch.text || "";

  readCount++;
  localStorage.setItem("read", readCount);
  document.getElementById("statRead").textContent = readCount;
}

function prevChapter(){
  if(!currentNovelId) return;
  const n = DATA[currentNovelId];
  if(currentChapterIndex <= 0) return;
  openChapter(currentNovelId, currentChapterIndex - 1);
}
function nextChapter(){
  if(!currentNovelId) return;
  const n = DATA[currentNovelId];
  if(currentChapterIndex >= n.chapters.length - 1) return;
  openChapter(currentNovelId, currentChapterIndex + 1);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===================== –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê ===================== */
async function reloadAll(){
  document.getElementById("libHint").textContent = "–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶";
  try{
    await loadData();
    renderLibrary();
    show("library");
  }catch(err){
    console.error(err);
    document.getElementById("libHint").textContent =
      "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤: novels / chapters.";
    alert(
      "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É.\n\n" +
      "1) –ù–∞–∂–º–∏ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞¬ª ‚Üí ¬´–í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞¬ª ‚Üí ¬´–ß–∏—Ç–∞—Ç–µ–ª—å¬ª\n" +
      "2) –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ª–∏—Å—Ç—ã –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è EXACTLY: novels –∏ chapters\n" +
      "3) –í –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏: id, title, description, cover, genres (–¥–ª—è novels)\n" +
      "   –∏ id, novel_id, title, text, is_paid, order (–¥–ª—è chapters)\n"
    );
  }
}

/* ===================== –°–¢–ê–†–¢ ===================== */
reloadAll();
</script>
</body>
</html>

