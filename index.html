<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K-–ù–æ–≤–µ–ª–ª—ã</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#111318;
  --muted:#6b7280;
  --accent:#e56a84;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.06);
}
body.dark{
  --bg:#0f1115;
  --card:#161a22;
  --text:#f3f4f6;
  --muted:#9ca3af;
  --border:#262b36;
  --shadow:0 10px 30px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  padding:14px 16px;
  font-weight:800;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
button{
  border:none;
  background:var(--accent);
  color:white;
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
}
.container{
  max-width:900px;
  margin:0 auto;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  border-radius:16px;
  padding:14px;
  margin:14px;
}
.hidden{display:none}
.novel{cursor:pointer}
.row{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.cover{
  width:72px;
  height:100px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid var(--border);
  flex:0 0 auto;
  background:rgba(0,0,0,.04);
}
.small{
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}
h2{margin:0 0 8px 0}
h3{margin:0}

.chapter{
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  margin-top:10px;
  cursor:pointer;
}
.chapter:hover{filter:brightness(.98)}
.chapter.locked{opacity:.55; cursor:not-allowed}

.readerHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.readerMeta{
  color:var(--muted);
  font-size:13px;
  margin-bottom:10px;
}
.readerText{
  /* –í–û–¢ –≠–¢–û –ì–õ–ê–í–ù–û–ï: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏–∑ Google Sheets */
  white-space: pre-wrap;
  line-height: 1.8;
  font-size: 16px;
}

.actions{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-top:14px;
}
.actionBtn{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
}
.likeBtn{
  border:1px solid var(--border);
  background:transparent;
  padding:8px 12px;
  border-radius:12px;
  cursor:pointer;
  display:flex;
  gap:8px;
  align-items:center;
}

.bottom{
  position:fixed;
  bottom:0; left:0; right:0;
  background:var(--card);
  border-top:1px solid var(--border);
}
.bottomInner{
  max-width:900px;
  margin:0 auto;
  display:flex;
  justify-content:space-around;
}
.tab{
  padding:12px 10px;
  font-size:13px;
  cursor:pointer;
  color:var(--muted);
}
.tab.active{color:var(--text); font-weight:700}
.padBottom{height:56px;}
</style>
</head>

<body>
<header class="container">
  <div>K-–ù–æ–≤–µ–ª–ª—ã</div>
  <button onclick="toggleTheme()">üåó</button>
</header>

<div class="container padBottom">

  <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
  <div id="library" class="card">
    <h2>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
    <div id="libraryList" class="small">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–û–í–ï–õ–õ–´ -->
  <div id="novelPage" class="hidden">
    <div class="card">
      <div class="row">
        <img id="novelCover" class="cover" alt="">
        <div style="flex:1">
          <h2 id="novelTitle"></h2>
          <div id="novelGenres" class="small"></div>
          <p id="novelDesc" class="small" style="margin:8px 0 0 0"></p>
        </div>
      </div>
      <div id="chapters" style="margin-top:12px"></div>
      <div class="actions">
        <button class="actionBtn" onclick="show('library')">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </div>

  <!-- –ß–ò–¢–ê–õ–ö–ê -->
  <div id="reader" class="hidden">
    <div class="card">
      <div class="readerHead">
        <h2 id="chapterTitle" style="margin:0"></h2>
        <button class="actionBtn" onclick="backToNovel()">‚Üê –ù–∞–∑–∞–¥</button>
      </div>
      <div id="chapterMeta" class="readerMeta"></div>
      <div id="chapterText" class="readerText"></div>

      <div class="actions">
        <button class="actionBtn" onclick="prevChapter()">‚Üê –ü—Ä–µ–¥.</button>
        <button class="actionBtn" onclick="nextChapter()">–°–ª–µ–¥ ‚Üí</button>
        <button class="likeBtn" onclick="likeChapter()">‚ù§Ô∏è <span id="likeCount">0</span></button>
      </div>
    </div>
  </div>

  <!-- –ü–†–û–§–ò–õ–¨ -->
  <div id="profile" class="hidden">
    <div class="card">
      <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <p>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≥–ª–∞–≤: <b id="statRead">0</b></p>
      <p>–õ–∞–π–∫–æ–≤: <b id="statLikes">0</b></p>
    </div>
  </div>

</div>

<!-- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ -->
<div class="bottom">
  <div class="bottomInner">
    <div id="tabLib" class="tab active" onclick="show('library')">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
    <div id="tabProf" class="tab" onclick="show('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand?.();

let DATA = {}; // –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ Google Sheets
const SHEET_ID = "1Cn6zEDo5nfoihe_p0bJxU6WICuhLN38NcWqyKOD7rA0";
const SHEETS = { novels:"novels", chapters:"chapters" };

// —Å—á—ë—Ç—á–∏–∫–∏
let readCount = Number(localStorage.getItem("read")||0);
let likes = Number(localStorage.getItem("likes")||0);

let currentNovelId = null;
let currentChapterIndex = null;

function setActiveTab(which){
  document.getElementById("tabLib").classList.toggle("active", which==="library");
  document.getElementById("tabProf").classList.toggle("active", which==="profile");
}

function show(id){
  ["library","novelPage","reader","profile"].forEach(x=>{
    const el = document.getElementById(x);
    if(el) el.classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");

  document.getElementById("statRead").textContent = readCount;
  document.getElementById("statLikes").textContent = likes;

  setActiveTab(id==="profile" ? "profile" : "library");
}

function gvizUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
}

async function fetchSheet(sheetName){
  const res = await fetch(gvizUrl(sheetName), {cache:"no-store"});
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
  const cols = json.table.cols.map(c => (c.label||"").trim());
  const rows = (json.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? (cell.v ?? "") : ""));
  return { cols, rows };
}

function toObjects(cols, rows){
  return rows
    .filter(r => r.some(v => String(v).trim() !== ""))
    .map(r => {
      const obj = {};
      cols.forEach((k,i)=> obj[k]=r[i]);
      return obj;
    });
}

async function loadData(){
  const novelsRaw = await fetchSheet(SHEETS.novels);
  const chaptersRaw = await fetchSheet(SHEETS.chapters);

  const novels = toObjects(novelsRaw.cols, novelsRaw.rows);
  const chapters = toObjects(chaptersRaw.cols, chaptersRaw.rows);

  // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≥–ª–∞–≤—ã –ø–æ novel_id
  const byNovel = {};
  for (const ch of chapters){
    const nid = String(ch.novel_id||"").trim();
    if(!nid) continue;

    if(!byNovel[nid]) byNovel[nid]=[];
    byNovel[nid].push({
      id: String(ch.id||"").trim(),
      title: String(ch.title||"").trim() || "–ì–ª–∞–≤–∞",
      text: String(ch.text||""),
      paid: String(ch.is_paid||"").toUpperCase()==="TRUE",
      order: ch.order ? Number(ch.order) : 0,
    });
  }
  Object.keys(byNovel).forEach(nid=>{
    byNovel[nid].sort((a,b)=>(a.order||0)-(b.order||0));
  });

  // –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ñ–æ—Ä–º–∞—Ç—É DATA
  const result = {};
  for (const n of novels){
    const id = String(n.id||"").trim();
    if(!id) continue;

    result[id] = {
      id,
      title: String(n.title||"").trim() || "–ù–æ–≤–µ–ª–ª–∞",
      desc: String(n.description||"").trim(),
      cover: String(n.cover||"").trim(),
      genres: String(n.genres||"").trim(),
      chapters: byNovel[id] || [],
    };
  }
  DATA = result;
}

function renderLibrary(){
  const list = document.getElementById("libraryList");
  const ids = Object.keys(DATA);

  if(!ids.length){
    list.textContent = "–ù–æ–≤–µ–ª–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å –ª–∏—Å—Ç novels –∏ –¥–æ—Å—Ç—É–ø ¬´–í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª.";
    return;
  }

  list.innerHTML = "";
  ids.forEach(id=>{
    const n = DATA[id];
    const div = document.createElement("div");
    div.className = "card novel";
    div.style.margin = "12px 0 0 0";
    div.innerHTML = `
      <div class="row">
        <img class="cover" src="${escapeHtml(n.cover)}" alt="">
        <div style="flex:1">
          <h3>${escapeHtml(n.title)}</h3>
          <div class="small">${escapeHtml(n.genres || "")} ¬∑ ${n.chapters.length} –≥–ª–∞–≤</div>
        </div>
      </div>
    `;
    div.onclick = ()=>openNovel(id);
    list.appendChild(div);
  });
}

function openNovel(id){
  const n = DATA[id];
  if(!n) return;

  currentNovelId = id;
  show("novelPage");

  document.getElementById("novelTitle").textContent = n.title;
  document.getElementById("novelDesc").textContent = n.desc || "";
  document.getElementById("novelGenres").textContent = n.genres || "";
  const coverEl = document.getElementById("novelCover");
  coverEl.src = n.cover || "";
  coverEl.style.display = n.cover ? "block" : "none";

  const chaptersEl = document.getElementById("chapters");
  chaptersEl.innerHTML = "";

  n.chapters.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "chapter" + (c.paid ? " locked" : "");
    div.innerHTML = `${escapeHtml(c.title)}${c.paid ? " üîí" : ""}`;
    div.onclick = ()=>openChapter(id, i);
    chaptersEl.appendChild(div);
  });

  if(!n.chapters.length){
    const empty = document.createElement("div");
    empty.className = "small";
    empty.style.marginTop = "10px";
    empty.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –≥–ª–∞–≤. –î–æ–±–∞–≤—å —Å—Ç—Ä–æ–∫–∏ –≤ –ª–∏—Å—Ç chapters.";
    chaptersEl.appendChild(empty);
  }
}

function openChapter(novelId, i){
  const novel = DATA[novelId];
  if(!novel) return;

  const ch = novel.chapters[i];
  if(!ch) return;

  if(ch.paid){
    alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç Telegram Payments üí≥");
    return;
  }

  currentNovelId = novelId;
  currentChapterIndex = i;

  show("reader");

  document.getElementById("chapterTitle").textContent = ch.title;
  document.getElementById("chapterMeta").textContent = `${novel.title} ¬∑ –ì–ª–∞–≤–∞ ${i+1} –∏–∑ ${novel.chapters.length}`;

  // –í–ê–ñ–ù–û: textContent + CSS white-space: pre-wrap = –∞–±–∑–∞—Ü—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
  document.getElementById("chapterText").textContent = ch.text;

  readCount++;
  localStorage.setItem("read", readCount);

  document.getElementById("likeCount").textContent = likes;
}

function backToNovel(){
  if(currentNovelId) openNovel(currentNovelId);
  else show("library");
}

function prevChapter(){
  if(currentNovelId==null || currentChapterIndex==null) return;
  const i = currentChapterIndex - 1;
  if(i < 0) return;
  openChapter(currentNovelId, i);
}
function nextChapter(){
  if(currentNovelId==null || currentChapterIndex==null) return;
  const i = currentChapterIndex + 1;
  const novel = DATA[currentNovelId];
  if(!novel) return;
  if(i >= novel.chapters.length) return;
  openChapter(currentNovelId, i);
}

function likeChapter(){
  likes++;
  localStorage.setItem("likes", likes);
  document.getElementById("likeCount").textContent = likes;
  document.getElementById("statLikes").textContent = likes;
}

function toggleTheme(){
  document.body.classList.toggle("dark");
}

// –ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–º–∞–Ω–∏—è HTML (–¥–ª—è title/genres)
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// —Å—Ç–∞—Ä—Ç
(async ()=>{
  try{
    await loadData();
    renderLibrary();
    show("library");
  }catch(err){
    console.error(err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø: ¬´–í—Å–µ —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤ novels/chapters.");
  }
})();
</script>

</body>
</html>
