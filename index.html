<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>K-–ù–æ–≤–µ–ª–ª—ã</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#111318;
  --muted:#6b7280;
  --border:rgba(17,19,24,.10);
  --accent:#e56a84;
  --shadow:0 10px 30px rgba(0,0,0,.06);
  --r16:16px;
}
body.dark{
  --bg:#0f1115;
  --card:#161a22;
  --text:#f3f4f6;
  --muted:#9ca3af;
  --border:rgba(255,255,255,.10);
  --shadow:0 12px 34px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header{
  position:sticky; top:0; z-index:5;
  background:var(--bg);
  padding:14px 16px;
  display:flex; align-items:center; justify-content:space-between;
}
.brand{font-weight:900; letter-spacing:.2px}
.iconBtn{
  border:none; background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.wrap{max-width:980px; margin:0 auto; padding:6px 10px 78px;}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r16);
  padding:14px;
  margin:12px 0;
  box-shadow:var(--shadow);
}
.novelRow{
  display:flex; gap:12px; align-items:center;
  cursor:pointer;
}
.cover{
  width:56px; height:74px; border-radius:12px;
  background:linear-gradient(135deg, rgba(229,106,132,.22), rgba(124,92,255,.18));
  border:1px solid var(--border);
  overflow:hidden;
  flex:0 0 auto;
}
.cover img{width:100%; height:100%; object-fit:cover; display:block}
.meta{min-width:0}
.meta b{font-size:16px}
.small{color:var(--muted); font-size:13px; margin-top:4px}
.hidden{display:none}

.chList{margin-top:10px}
.chItem{
  padding:12px;
  border:1px solid var(--border);
  border-radius:14px;
  margin:8px 0;
  cursor:pointer;
}
.chItem.locked{opacity:.55; cursor:not-allowed}
.readerText{
  white-space:pre-wrap; /* –≤–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ */
  line-height:1.55;
  font-size:16px;
}
.readerTop{
  display:flex; justify-content:space-between; align-items:center; gap:10px;
}
.btnRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.btn{
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  border-radius:12px;
  padding:8px 12px;
  cursor:pointer;
}
.btnPrimary{
  border:none;
  background:var(--accent);
  color:#fff;
}
.bottom{
  position:fixed; left:0; right:0; bottom:0;
  background:var(--card);
  border-top:1px solid var(--border);
  padding:10px 8px;
}
.bottomInner{
  max-width:980px;
  margin:0 auto;
  display:flex;
  justify-content:space-around;
  gap:8px;
}
.tab{
  flex:1;
  text-align:center;
  padding:10px 8px;
  border-radius:14px;
  cursor:pointer;
  border:1px solid transparent;
}
.tab.active{border-color:var(--border); background:rgba(0,0,0,.03)}
body.dark .tab.active{background:rgba(255,255,255,.06)}
.note{
  color:var(--muted);
  font-size:13px;
  margin-top:6px;
}
</style>
</head>

<body>
<header>
  <div class="brand">K-–ù–æ–≤–µ–ª–ª—ã</div>
  <button class="iconBtn" onclick="toggleTheme()" title="–¢–µ–º–∞">üåó</button>
</header>

<div class="wrap">
  <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
  <div id="library" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <div>
        <div style="font-weight:900;font-size:20px">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
        <div class="note" id="libHint">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
      <button class="iconBtn" onclick="hardReload()" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
    </div>
    <div id="novelList" style="margin-top:10px"></div>
  </div>

  <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–û–í–ï–õ–õ–´ -->
  <div id="novelPage" class="hidden">
    <div class="card">
      <div class="btnRow">
        <button class="btn" onclick="show('library')">‚Üê –ù–∞–∑–∞–¥</button>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div class="cover" id="novelCover"></div>
        <div class="meta">
          <b id="novelTitle"></b>
          <div class="small" id="novelGenres"></div>
          <div class="small" id="novelDesc"></div>
        </div>
      </div>

      <div class="chList" id="chapters"></div>
    </div>
  </div>

  <!-- –ß–ò–¢–ê–õ–ö–ê -->
  <div id="reader" class="hidden">
    <div class="card">
      <div class="readerTop">
        <button class="btn" onclick="backToNovel()">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="btnRow">
          <button class="btn" onclick="prevChapter()">‚Üê –ü—Ä–µ–¥.</button>
          <button class="btn" onclick="nextChapter()">–°–ª–µ–¥. ‚Üí</button>
          <button class="btn" onclick="like()">‚ù§Ô∏è –õ–∞–π–∫</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:900;font-size:22px" id="chapterTitle"></div>
        <div class="small" id="chapterSub"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />

      <div class="readerText" id="chapterText"></div>
    </div>
  </div>

  <!-- –ü–†–û–§–ò–õ–¨ -->
  <div id="profile" class="hidden">
    <div class="card">
      <div style="font-weight:900;font-size:20px">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="note">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
      <div style="margin-top:10px">
        <div>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≥–ª–∞–≤: <b id="statRead">0</b></div>
        <div>–õ–∞–π–∫–æ–≤: <b id="statLikes">0</b></div>
      </div>
      <div class="note" style="margin-top:10px">–ï—Å–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Äî –Ω–∞–∂–º–∏ ¬´‚Üª¬ª –∏–ª–∏ Ctrl+F5.</div>
    </div>
  </div>
</div>

<div class="bottom">
  <div class="bottomInner">
    <div class="tab active" id="tabLib" onclick="show('library')">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
    <div class="tab" id="tabProf" onclick="show('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
</div>

<script>
/* =====================
   –ù–ê–°–¢–†–û–ô–ö–ò –¢–ê–ë–õ–ò–¶–´
===================== */
const SHEET_ID = "1Cn6zEDo5nfoihe_p0bJxU6WICuhLN38NcWqyKOD7rA0";
const SHEETS = { novels:"novels", chapters:"chapters" };

/* =====================
   TELEGRAM
===================== */
const tg = window.Telegram?.WebApp;
tg?.expand?.();

/* =====================
   –°–û–°–¢–û–Ø–ù–ò–ï
===================== */
let DATA = {};                 // DATA[novelId] = {title, desc, cover, genres, chapters:[]}
let currentNovelId = null;
let currentChapterIndex = 0;

let readCount = Number(localStorage.getItem("read")||0);
let likes = Number(localStorage.getItem("likes")||0);

/* =====================
   –£–¢–ò–õ–ò–¢–´
===================== */
function gvizUrl(sheetName){
  // –í–ê–ñ–ù–û: out:json, –∏–Ω–∞—á–µ parse –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
}

async function fetchSheet(sheetName){
  const res = await fetch(gvizUrl(sheetName), { cache: "no-store" });
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
  const cols = json.table.cols.map(c => (c.label||"").trim());
  const rows = (json.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? (cell.v ?? "") : ""));
  return { cols, rows };
}

function toObjects(cols, rows){
  return rows
    .filter(r => r.some(v => String(v).trim() !== ""))
    .map(r => {
      const obj = {};
      cols.forEach((k,i)=> obj[k]=r[i]);
      return obj;
    });
}

function norm(v){ return String(v ?? "").trim(); }

function parseBool(v){
  const s = String(v ?? "").trim().toUpperCase();
  return s === "TRUE" || s === "1" || s === "YES";
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* =====================
   –ì–õ–ê–í–ù–ê–Ø –§–ò–ß–ê: –°–ö–õ–ï–ô–ö–ê –¢–ï–ö–°–¢–ê
   - –ï—Å–ª–∏ —É –≥–ª–∞–≤—ã –º–Ω–æ–≥–æ —Å—Ç—Ä–æ–∫ (–∞–±–∑–∞—Ü—ã –≤–Ω–∏–∑), –º—ã —Å–∫–ª–µ–∏–º –∏—Ö –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç.
   - –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ (novel_id + title).
   - –í–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π –≥–ª–∞–≤—ã –±–µ—Ä—ë–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å–æ–µ–¥–∏–Ω—è–µ–º –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏.
===================== */
function buildChaptersWithMerge(chapters){
  // 1) –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ order, –µ—Å–ª–∏ –µ—Å—Ç—å (—á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∏ —à–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
  const prep = chapters.map(ch => ({
    novel_id: norm(ch.novel_id),
    title: norm(ch.title) || "–ì–ª–∞–≤–∞",
    text: String(ch.text ?? ""),
    is_paid: parseBool(ch.is_paid),
    order: ch.order !== "" && ch.order != null ? Number(ch.order) : 0,
    id: norm(ch.id)
  }));

  // 2) –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: –∫–ª—é—á = novel_id + "||" + title
  const map = new Map();

  for(const row of prep){
    if(!row.novel_id) continue;
    const key = `${row.novel_id}||${row.title}`;
    if(!map.has(key)){
      map.set(key, {
        novel_id: row.novel_id,
        title: row.title,
        paid: row.is_paid,
        order: row.order || 0,
        parts: [],
      });
    }
    const g = map.get(key);
    // paid: –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ TRUE ‚Äî —Å—á–∏—Ç–∞–µ–º –ø–ª–∞—Ç–Ω–æ–π
    g.paid = g.paid || row.is_paid;
    // order: –±–µ—Ä—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, —á—Ç–æ–±—ã –≥–ª–∞–≤–∞ –≤—Å—Ç–∞–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    if(typeof row.order === "number" && row.order){
      if(!g.order || row.order < g.order) g.order = row.order;
    }
    // –¥–æ–±–∞–≤–ª—è–µ–º –∫—É—Å–æ–∫ —Ç–µ–∫—Å—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π/–ø—Ä–æ–±–µ–ª—å–Ω—ã–π ‚Äî –Ω–æ –ª—É—á—à–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –º—É—Å–æ—Ä
    const t = String(row.text ?? "");
    if(t.trim() !== "") g.parts.push(t);
  }

  // 3) –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –≥—Ä—É–ø–ø—ã –≤ –º–∞—Å—Å–∏–≤ –≥–ª–∞–≤
  const merged = [];
  for(const g of map.values()){
    // –°–∫–ª–µ–∏–≤–∞–µ–º –∞–±–∑–∞—Ü–∞–º–∏.
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞–ª —Å—Ç—Ä–æ–∫–∏-–∞–±–∑–∞—Ü—ã ‚Äî –æ–Ω–∏ –æ–±—ä–µ–¥–∏–Ω—è—Ç—Å—è.
    const text = g.parts.join("\n\n");
    merged.push({
      title: g.title,
      text,
      paid: g.paid,
      order: g.order || 0,
    });
  }

  // 4) —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≥–ª–∞–≤ –ø–æ order (–∏ –∑–∞–ø–∞—Å–Ω–æ–π ‚Äî –ø–æ title)
  merged.sort((a,b)=>{
    const ao = Number(a.order||0), bo = Number(b.order||0);
    if(ao !== bo) return ao - bo;
    return String(a.title).localeCompare(String(b.title), "ru");
  });

  return merged;
}

/* =====================
   –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
===================== */
async function loadData(){
  const novelsRaw = await fetchSheet(SHEETS.novels);
  const chaptersRaw = await fetchSheet(SHEETS.chapters);

  const novels = toObjects(novelsRaw.cols, novelsRaw.rows);
  const chapters = toObjects(chaptersRaw.cols, chaptersRaw.rows);

  // —Å–∫–ª–µ–π–∫–∞ –≥–ª–∞–≤
  const mergedChapters = buildChaptersWithMerge(chapters);

  // —Ä–∞–∑–ª–æ–∂–∏–º –ø–æ –Ω–æ–≤–µ–ª–ª–∞–º
  const byNovel = {};
  for(const ch of mergedChapters){
    if(!byNovel[ch.novel_id]) byNovel[ch.novel_id] = [];
    byNovel[ch.novel_id].push({
      title: ch.title,
      text: ch.text,
      paid: ch.paid,
      order: ch.order
    });
  }

  // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π DATA
  const result = {};
  for(const n of novels){
    const id = norm(n.id);
    if(!id) continue;
    result[id] = {
      title: norm(n.title) || "–ù–æ–≤–µ–ª–ª–∞",
      desc: norm(n.description),
      cover: norm(n.cover),
      genres: norm(n.genres),
      chapters: byNovel[id] || [],
    };
  }

  DATA = result;
}

/* =====================
   –†–ï–ù–î–ï–† / –ù–ê–í–ò–ì–ê–¶–ò–Ø
===================== */
function show(id){
  ["library","novelPage","reader","profile"].forEach(x=>{
    document.getElementById(x).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");

  // —Ç–∞–±—ã
  document.getElementById("tabLib").classList.toggle("active", id==="library");
  document.getElementById("tabProf").classList.toggle("active", id==="profile");

  // —Å—Ç–∞—Ç—ã
  document.getElementById("statRead").textContent = readCount;
  document.getElementById("statLikes").textContent = likes;
}

function renderLibrary(){
  const list = document.getElementById("novelList");
  list.innerHTML = "";

  const ids = Object.keys(DATA);
  if(ids.length === 0){
    document.getElementById("libHint").textContent =
      "–ù–æ–≤–µ–ª–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å –ª–∏—Å—Ç novels –∏ –¥–æ—Å—Ç—É–ø ¬´–í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª.";
    return;
  }

  document.getElementById("libHint").textContent = `–ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–µ–ª–ª: ${ids.length}`;

  ids.forEach(id=>{
    const n = DATA[id];
    const chCount = (n.chapters||[]).length;
    const div = document.createElement("div");
    div.className = "card novelRow";
    div.onclick = ()=>openNovel(id);

    const cover = document.createElement("div");
    cover.className = "cover";
    if(n.cover){
      cover.innerHTML = `<img alt="" src="${escapeHtml(n.cover)}" />`;
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `
      <b>${escapeHtml(n.title)}</b>
      <div class="small">${escapeHtml(n.genres || "‚Äî")} ¬∑ ${chCount} –≥–ª–∞–≤</div>
    `;

    div.appendChild(cover);
    div.appendChild(meta);
    list.appendChild(div);
  });
}

function openNovel(id){
  const n = DATA[id];
  currentNovelId = id;

  show("novelPage");
  document.getElementById("novelTitle").textContent = n.title;
  document.getElementById("novelDesc").textContent = n.desc || "";
  document.getElementById("novelGenres").textContent = n.genres || "";

  const coverBox = document.getElementById("novelCover");
  coverBox.innerHTML = "";
  if(n.cover){
    coverBox.innerHTML = `<img alt="" src="${escapeHtml(n.cover)}" />`;
  }

  const chBox = document.getElementById("chapters");
  chBox.innerHTML = "";

  if(!n.chapters || n.chapters.length === 0){
    chBox.innerHTML = `<div class="note">–ì–ª–∞–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
    return;
  }

  n.chapters.forEach((c,i)=>{
    const item = document.createElement("div");
    item.className = "chItem" + (c.paid ? " locked" : "");
    item.innerHTML = `${escapeHtml(c.title)}${c.paid ? " üîí" : ""}`;
    item.onclick = ()=>openChapter(id, i);
    chBox.appendChild(item);
  });
}

function openChapter(novelId, index){
  const n = DATA[novelId];
  const ch = n.chapters[index];
  if(!ch) return;

  if(ch.paid){
    alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç Telegram Payments üí≥");
    return;
  }

  currentNovelId = novelId;
  currentChapterIndex = index;

  show("reader");
  document.getElementById("chapterTitle").textContent = ch.title;

  // –≤–∞–∂–Ω–æ–µ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–Å, –≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ–Ω–æ—Å—ã
  document.getElementById("chapterText").textContent = ch.text || "";

  document.getElementById("chapterSub").textContent =
    `${n.title} ¬∑ –ì–ª–∞–≤–∞ ${index+1} –∏–∑ ${n.chapters.length}`;

  readCount++;
  localStorage.setItem("read", String(readCount));
}

function backToNovel(){
  if(currentNovelId) openNovel(currentNovelId);
  else show("library");
}

function prevChapter(){
  if(!currentNovelId) return;
  const n = DATA[currentNovelId];
  if(!n?.chapters?.length) return;
  const next = Math.max(0, currentChapterIndex - 1);
  openChapter(currentNovelId, next);
}

function nextChapter(){
  if(!currentNovelId) return;
  const n = DATA[currentNovelId];
  if(!n?.chapters?.length) return;
  const next = Math.min(n.chapters.length - 1, currentChapterIndex + 1);
  openChapter(currentNovelId, next);
}

function like(){
  likes++;
  localStorage.setItem("likes", String(likes));
  document.getElementById("statLikes").textContent = likes;
  alert("–õ–∞–π–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚ù§Ô∏è");
}

function toggleTheme(){
  document.body.classList.toggle("dark");
}

function hardReload(){
  // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∫–µ—à–∞
  init(true);
}

/* =====================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
===================== */
async function init(isManual){
  try{
    document.getElementById("libHint").textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    await loadData();
    renderLibrary();
    show("library");
  }catch(err){
    console.error(err);
    document.getElementById("libHint").textContent =
      "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å: –ª–∏—Å—Ç—ã –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è novels –∏ chapters, –¥–æ—Å—Ç—É–ø ¬´–í—Å–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª.";
    if(isManual) alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ª–∏—Å—Ç–æ–≤.");
  }
}

init(false);
</script>
</body>
</html>

