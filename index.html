<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>K-–ù–æ–≤–µ–ª–ª—ã</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#111318;
  --muted:#6b7280;
  --accent:#e56a84;
  --border:rgba(17,19,24,.10);
  --shadow:0 10px 30px rgba(0,0,0,.06);
  --r14:14px;
  --r18:18px;
}
body.dark{
  --bg:#0f1115;
  --card:#161a22;
  --text:#f3f4f6;
  --muted:#9ca3af;
  --border:rgba(255,255,255,.10);
  --shadow:0 16px 40px rgba(0,0,0,.28);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
a{color:inherit}
header{
  position:sticky; top:0; z-index:10;
  background:color-mix(in srgb, var(--bg) 86%, white 14%);
  border-bottom:1px solid var(--border);
  backdrop-filter:saturate(180%) blur(10px);
  padding:12px 14px;
}
.head-inner{
  max-width:980px; margin:0 auto;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
}
.brand{font-weight:900}
.iconbtn{
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  padding:8px 10px;
  border-radius:12px;
  cursor:pointer;
}
.wrap{max-width:980px;margin:0 auto;padding:14px 14px 84px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r18);
  box-shadow:var(--shadow);
  padding:14px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:12px;
}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
.novel{cursor:pointer}
.novel .title{font-weight:900;margin:10px 0 4px}
.novel .meta{color:var(--muted);font-size:13px}
.cover{
  width:100%; height:190px;
  border-radius:var(--r14);
  border:1px solid var(--border);
  overflow:hidden;
  background:linear-gradient(135deg,#eee,#f7f7f7);
}
.cover img{width:100%;height:100%;object-fit:cover;display:block}
.hidden{display:none}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.small{color:var(--muted);font-size:13px;line-height:1.45}
.chapters{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.chapter{
  border:1px solid var(--border);
  background:transparent;
  border-radius:14px;
  padding:10px 12px;
  cursor:pointer;
  display:flex;justify-content:space-between;align-items:center;
}
.chapter.locked{opacity:.6}
.badge{
  font-size:12px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:color-mix(in srgb, var(--accent) 12%, var(--card) 88%);
}
.readerText{
  white-space:pre-wrap;
  line-height:1.7;
  font-size:15px;
}
hr.sep{
  border:none;height:1px;background:var(--border);margin:12px 0;
}
.bottom{
  position:fixed;bottom:0;left:0;right:0;z-index:20;
  background:color-mix(in srgb, var(--bg) 86%, white 14%);
  border-top:1px solid var(--border);
  backdrop-filter:saturate(180%) blur(10px);
}
.bottom-inner{
  max-width:980px;margin:0 auto;
  display:flex;justify-content:space-around;
  padding:10px 8px;
}
.tab{
  cursor:pointer;
  padding:8px 12px;
  border-radius:14px;
  color:var(--muted);
  font-size:13px;
}
.tab.active{
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
}
.toast{
  position:fixed;left:50%;bottom:86px;transform:translateX(-50%);
  background:rgba(17,19,24,.92);color:white;
  padding:10px 12px;border-radius:12px;
  font-size:13px;display:none;z-index:50;
}
</style>
</head>

<body>
<header>
  <div class="head-inner">
    <div class="brand" id="appTitle">K-–ù–æ–≤–µ–ª–ª—ã</div>
    <button class="iconbtn" id="themeBtn" title="–°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞">üåó</button>
  </div>
</header>

<div class="wrap">

  <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
  <section id="library">
    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900;font-size:16px">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
          <div class="small" id="libSub">–ó–∞–≥—Ä—É–∂–∞—é –Ω–æ–≤–µ–ª–ª—ã –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã‚Ä¶</div>
        </div>
        <button class="iconbtn" id="reloadBtn" title="–û–±–Ω–æ–≤–∏—Ç—å">‚ü≤</button>
      </div>
      <hr class="sep">
      <div class="grid" id="libraryList"></div>
      <div class="small" id="libEmpty" style="display:none;margin-top:10px">
        –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å –ª–∏—Å—Ç <b>novels</b> –∏ –¥–æ—Å—Ç—É–ø ¬´–í—Å–µ —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª.
      </div>
    </div>
  </section>

  <!-- –°–¢–†–ê–ù–ò–¶–ê –ù–û–í–ï–õ–õ–´ -->
  <section id="novelPage" class="hidden">
    <div class="card">
      <button class="iconbtn" onclick="show('library')">‚Üê –ù–∞–∑–∞–¥</button>
      <div style="height:10px"></div>
      <div class="cover" id="novelCoverWrap"></div>
      <div class="title" style="font-weight:900;font-size:18px;margin:12px 0 6px" id="novelTitle">‚Äî</div>
      <div class="small" id="novelGenres">‚Äî</div>
      <div style="height:8px"></div>
      <div class="small" id="novelDesc">‚Äî</div>
      <hr class="sep">
      <div style="font-weight:900;margin-bottom:8px">–ì–ª–∞–≤—ã</div>
      <div class="chapters" id="chapters"></div>
    </div>
  </section>

  <!-- –ß–ò–¢–ê–õ–ö–ê -->
  <section id="reader" class="hidden">
    <div class="card">
      <button class="iconbtn" onclick="backFromReader()">‚Üê –ù–∞–∑–∞–¥</button>
      <div style="height:10px"></div>
      <div style="font-weight:900;font-size:18px" id="chapterTitle">‚Äî</div>
      <div class="small" id="chapterMeta">‚Äî</div>
      <hr class="sep">
      <div class="readerText" id="chapterText">‚Äî</div>
      <hr class="sep">
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="iconbtn" id="prevBtn">‚Üê –ü—Ä–µ–¥.</button>
        <button class="iconbtn" id="nextBtn">–°–ª–µ–¥. ‚Üí</button>
        <button class="iconbtn" id="likeBtn">‚ù§Ô∏è –õ–∞–π–∫</button>
      </div>
    </div>
  </section>

  <!-- –ü–†–û–§–ò–õ–¨ -->
  <section id="profile" class="hidden">
    <div class="card">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="small">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –≥–ª–∞–≤: <b id="statRead">0</b></div>
      <div class="small">–õ–∞–π–∫–æ–≤: <b id="statLikes">0</b></div>
      <div class="small" style="margin-top:10px">
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Ç–≤–æ—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (localStorage).
      </div>
    </div>
  </section>

</div>

<div class="bottom">
  <div class="bottom-inner">
    <div class="tab active" data-tab="library">üìö –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</div>
    <div class="tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ========= Telegram WebApp =========
const tg = window.Telegram?.WebApp;
try{ tg?.expand(); }catch(e){}

// ========= –ù–ê–°–¢–†–û–ô–ö–ò GOOGLE SHEETS =========
const SHEET_ID = "1Cn6zEDo5nfoihe_p0bJxU6WICuhLN38NcWqyKOD7rA0";
const SHEETS = { novels:"novels", chapters:"chapters" };

// –û–∂–∏–¥–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
// novels: id | title | description | cover | genres
// chapters: id | novel_id | title | text | is_paid | order (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

// ========= State =========
let DATA = {};              // { n1: {title, desc, cover, genres, chapters:[{id,title,text,paid,order}]} }
let currentNovelId = null;
let currentChapterIndex = 0;

// stats (–ª–æ–∫–∞–ª—å–Ω–æ)
let readCount = Number(localStorage.getItem("read")||0);
let likes = Number(localStorage.getItem("likes")||0);

// theme
const THEME_KEY = "theme_v1";
if (localStorage.getItem(THEME_KEY)==="dark") document.body.classList.add("dark");

// ========= UI refs =========
const $ = (id)=>document.getElementById(id);
const appTitle = $("appTitle");
const libSub = $("libSub");
const libraryList = $("libraryList");
const libEmpty = $("libEmpty");
const reloadBtn = $("reloadBtn");
const themeBtn = $("themeBtn");
const toast = $("toast");

const novelCoverWrap = $("novelCoverWrap");
const novelTitle = $("novelTitle");
const novelDesc = $("novelDesc");
const novelGenres = $("novelGenres");
const chaptersEl = $("chapters");

const chapterTitle = $("chapterTitle");
const chapterMeta = $("chapterMeta");
const chapterText = $("chapterText");
const prevBtn = $("prevBtn");
const nextBtn = $("nextBtn");
const likeBtn = $("likeBtn");

const statRead = $("statRead");
const statLikes = $("statLikes");

// ========= Helpers =========
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.style.display="none", 1400);
}
function show(id){
  ["library","novelPage","reader","profile"].forEach(x=>$(x).classList.add("hidden"));
  $(id).classList.remove("hidden");
  // –æ–±–Ω–æ–≤–∏–º –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
  statRead.textContent = String(readCount);
  statLikes.textContent = String(likes);
  // —Ç–∞–±—ã
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === id);
  });
}
function gvizUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
}
async function fetchSheet(sheetName){
  const res = await fetch(gvizUrl(sheetName), { cache: "no-store" });
  const text = await res.text();
  const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}")+1));
  const cols = json.table.cols.map(c => (c.label||"").trim());
  const rows = (json.table.rows||[]).map(r => (r.c||[]).map(cell => cell ? (cell.v ?? "") : ""));
  return { cols, rows };
}
function toObjects(cols, rows){
  return rows
    .filter(r => r.some(v => String(v).trim() !== ""))
    .map(r => {
      const obj = {};
      cols.forEach((k,i)=> obj[k] = r[i]);
      return obj;
    });
}
function normBool(v){
  return String(v||"").trim().toUpperCase()==="TRUE" || String(v||"").trim()==="1";
}

// ========= Load from Sheets =========
async function loadData(){
  libSub.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –Ω–æ–≤–µ–ª–ª—ã –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã‚Ä¶";
  libEmpty.style.display = "none";

  const novelsRaw = await fetchSheet(SHEETS.novels);
  const chaptersRaw = await fetchSheet(SHEETS.chapters);

  const novels = toObjects(novelsRaw.cols, novelsRaw.rows);
  const chapters = toObjects(chaptersRaw.cols, chaptersRaw.rows);

  // chapters by novel
  const byNovel = {};
  for (const ch of chapters){
    const nid = String(ch.novel_id||"").trim();
    if (!nid) continue;
    (byNovel[nid] ||= []).push({
      id: String(ch.id||"").trim(),
      title: String(ch.title||"").trim() || "–ì–ª–∞–≤–∞",
      text: String(ch.text||""),
      paid: normBool(ch.is_paid),
      order: ch.order ? Number(ch.order) : 0,
    });
  }
  Object.keys(byNovel).forEach(nid=>{
    byNovel[nid].sort((a,b)=> (a.order||0)-(b.order||0) || String(a.id).localeCompare(String(b.id)));
  });

  // build DATA
  const result = {};
  for (const n of novels){
    const id = String(n.id||"").trim();
    if (!id) continue;
    const genres = String(n.genres||"")
      .split(",")
      .map(x=>x.trim())
      .filter(Boolean);

    result[id] = {
      title: String(n.title||"").trim() || "–ù–æ–≤–µ–ª–ª–∞",
      desc: String(n.description||"").trim(),
      cover: String(n.cover||"").trim(),
      genres,
      chapters: byNovel[id] || [],
    };
  }

  DATA = result;

  const count = Object.keys(DATA).length;
  libSub.textContent = count ? `–ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–µ–ª–ª: ${count}` : "–ù–æ–≤–µ–ª–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
  renderLibrary();
}

// ========= Render library =========
function renderLibrary(){
  libraryList.innerHTML = "";
  const ids = Object.keys(DATA);

  if (!ids.length){
    libEmpty.style.display = "block";
    return;
  }
  libEmpty.style.display = "none";

  ids.forEach(id=>{
    const n = DATA[id];
    const chCount = (n.chapters||[]).length;

    const card = document.createElement("div");
    card.className = "card novel";
    card.onclick = ()=>openNovel(id);

    const cover = n.cover ? `<div class="cover"><img src="${escapeHtml(n.cover)}" alt="cover"></div>` : `<div class="cover"></div>`;
    const genres = (n.genres||[]).length ? escapeHtml(n.genres.join(" ¬∑ ")) : "‚Äî";

    card.innerHTML = `
      ${cover}
      <div class="title">${escapeHtml(n.title)}</div>
      <div class="meta">${genres} ${chCount ? "¬∑ " + chCount + " –≥–ª–∞–≤" : ""}</div>
    `;
    libraryList.appendChild(card);
  });
}

// ========= Novel page =========
function openNovel(id){
  const n = DATA[id];
  if (!n){
    alert("–ù–µ –Ω–∞—à–ª–∞ –Ω–æ–≤–µ–ª–ª—É. –ü—Ä–æ–≤–µ—Ä—å id –≤ –ª–∏—Å—Ç–µ novels.");
    return;
  }
  currentNovelId = id;
  show("novelPage");

  // cover
  if (n.cover){
    novelCoverWrap.innerHTML = `<img src="${escapeHtml(n.cover)}" alt="cover">`;
    novelCoverWrap.className = "cover";
  } else {
    novelCoverWrap.innerHTML = "";
    novelCoverWrap.className = "cover";
  }

  novelTitle.textContent = n.title;
  novelDesc.textContent = n.desc || "";
  novelGenres.textContent = (n.genres||[]).length ? n.genres.map(g=>`#${g}`).join(" ¬∑ ") : "";

  chaptersEl.innerHTML = "";
  if (!n.chapters.length){
    chaptersEl.innerHTML = `<div class="small">–ì–ª–∞–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
    return;
  }

  n.chapters.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "chapter" + (c.paid ? " locked" : "");
    div.innerHTML = `
      <div>${escapeHtml(c.title)}</div>
      <div class="badge">${c.paid ? "üîí –ü–ª–∞—Ç–Ω–æ" : "–ë–µ—Å–ø–ª–∞—Ç–Ω–æ"}</div>
    `;
    div.onclick = ()=>openChapter(id,i);
    chaptersEl.appendChild(div);
  });
}

// ========= Reader =========
function openChapter(novelId, i){
  const novel = DATA[novelId];
  if (!novel) return;

  const ch = novel.chapters[i];
  if (!ch) return;

  if (ch.paid){
    alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç Telegram Payments / Stars üí≥ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞).");
    return;
  }

  currentNovelId = novelId;
  currentChapterIndex = i;

  show("reader");
  chapterTitle.textContent = ch.title;
  chapterMeta.textContent = `${novel.title} ¬∑ –ì–ª–∞–≤–∞ ${i+1} –∏–∑ ${novel.chapters.length}`;
  chapterText.textContent = ch.text;

  readCount++;
  localStorage.setItem("read", String(readCount));

  prevBtn.disabled = i===0;
  nextBtn.disabled = i===novel.chapters.length-1;

  prevBtn.onclick = ()=>openChapter(novelId, Math.max(0, i-1));
  nextBtn.onclick = ()=>openChapter(novelId, Math.min(novel.chapters.length-1, i+1));
}

function backFromReader(){
  if (currentNovelId) openNovel(currentNovelId);
  else show("library");
}

likeBtn.onclick = ()=>{
  likes++;
  localStorage.setItem("likes", String(likes));
  showToast("‚ù§Ô∏è –õ–∞–π–∫!");
  statLikes.textContent = String(likes);
};

// ========= Theme =========
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem(THEME_KEY, document.body.classList.contains("dark") ? "dark" : "light");
}

// ========= Bottom tabs =========
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = ()=>show(t.dataset.tab);
});

// ========= Buttons =========
themeBtn.onclick = toggleTheme;
reloadBtn.onclick = ()=>{
  loadData().then(()=>showToast("–û–±–Ω–æ–≤–ª–µ–Ω–æ")).catch(err=>{
    console.error(err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø: ¬´–í—Å–µ —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª.");
  });
};

// ========= Init =========
loadData()
  .then(()=>show("library"))
  .catch(err=>{
    console.error(err);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø: ¬´–í—Å–µ —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ ‚Äî –ß–∏—Ç–∞—Ç–µ–ª—å¬ª. \n–ò –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ª–∏—Å—Ç—ã –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è: novels –∏ chapters.");
  });

</script>
</body>
</html>
