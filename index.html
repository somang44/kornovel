<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–æ–≤–µ–ª–ª</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111318;
      --muted:#6b7280;
      --border:rgba(17,19,24,.08);
      --accent:#e56a84;
      --accent2:#7c5cff;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --r16:16px;
      --r14:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{max-width:980px;margin:0 auto;padding:16px 16px 84px}
    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(180%) blur(10px);
      background:color-mix(in srgb, var(--bg) 84%, white 16%);
      border-bottom:1px solid var(--border);
      padding:12px 16px;
    }
    .topbar-inner{max-width:980px;margin:0 auto;display:flex;gap:12px;align-items:center}
    .brand{
      display:flex;gap:10px;align-items:center;min-width:180px
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow);
    }
    .brand h1{font-size:14px;margin:0;line-height:1.1}
    .brand p{font-size:12px;margin:0;color:var(--muted)}
    .search{
      flex:1;display:flex;gap:8px;align-items:center;
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      padding:10px 12px;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .search input{
      border:none;outline:none;background:transparent;width:100%;
      font-size:14px;color:var(--text)
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;border:1px solid var(--border);
      background:var(--card);font-size:13px;color:var(--text);
      cursor:pointer;user-select:none;
    }
    .pill small{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:var(--r16);
      box-shadow:var(--shadow);
    }
    .card-h{padding:14px 14px 10px;display:flex;justify-content:space-between;align-items:center}
    .card-h h2{font-size:14px;margin:0}
    .card-h .sub{font-size:12px;color:var(--muted)}
    .card-b{padding:0 14px 14px}
    .hero{
      padding:14px;
      display:flex;gap:14px;align-items:stretch;
    }
    .hero .welcome{
      flex:1;background:linear-gradient(135deg, #fff, #fff), linear-gradient(135deg,var(--accent),var(--accent2));
      background-clip:padding-box,border-box;
      border:1px solid transparent;
      border-radius:var(--r16);
      padding:14px;
    }
    .hero h3{margin:0 0 6px;font-size:16px}
    .hero p{margin:0;color:var(--muted);line-height:1.45;font-size:13px}
    .hero .cta{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:none;cursor:pointer;
      padding:10px 12px;border-radius:12px;font-weight:600;
      background:var(--text);color:white;font-size:13px;
    }
    .btn.secondary{
      background:transparent;color:var(--text);
      border:1px solid var(--border);
    }
    .btn.pink{background:linear-gradient(135deg,var(--accent),color-mix(in srgb,var(--accent2) 55%, var(--accent) 45%))}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:transparent;color:var(--text);font-size:13px;cursor:pointer;
    }
    .chip.active{background:color-mix(in srgb, var(--accent) 12%, white 88%);border-color:color-mix(in srgb, var(--accent) 35%, var(--border) 65%)}
    .list{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.list{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (max-width:520px){.list{grid-template-columns:1fr;}}
    .novel{
      border:1px solid var(--border);
      border-radius:var(--r16);
      overflow:hidden;
      background:var(--card);
      display:flex;flex-direction:column;
      cursor:pointer;
      transition:.15s transform, .15s box-shadow;
    }
    .novel:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(0,0,0,.08)}
    .cover{
      height:180px;background:linear-gradient(135deg,#eee,#f7f7f7);
      position:relative;
    }
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;left:10px;top:10px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.9);border:1px solid var(--border);
      font-size:12px;
    }
    .novel-b{padding:12px}
    .title{font-weight:800;font-size:14px;margin:0 0 6px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px
    }
    .mini{
      border:1px solid var(--border);background:transparent;border-radius:12px;
      padding:8px 10px;font-size:12px;cursor:pointer;
    }
    .mini.primary{background:color-mix(in srgb, var(--accent) 14%, white 86%);border-color:color-mix(in srgb, var(--accent) 30%, var(--border) 70%)}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .empty{
      padding:12px;border:1px dashed var(--border);border-radius:14px;color:var(--muted);
      font-size:13px;
    }

    /* Reader */
    .reader{
      display:none;
      position:fixed;inset:0;z-index:50;
      background:color-mix(in srgb, var(--bg) 82%, white 18%);
      overflow:auto;
    }
    .reader-inner{max-width:860px;margin:0 auto;padding:16px 16px 28px}
    .reader-top{
      position:sticky;top:0;z-index:2;
      backdrop-filter:saturate(180%) blur(10px);
      background:color-mix(in srgb, var(--bg) 85%, white 15%);
      border-bottom:1px solid var(--border);
      padding:10px 16px;
    }
    .reader-top-inner{max-width:860px;margin:0 auto;display:flex;align-items:center;gap:10px}
    .iconbtn{
      border:1px solid var(--border);
      background:var(--card);
      padding:9px 11px;border-radius:12px;
      cursor:pointer;font-weight:700;
    }
    .reader h1{font-size:18px;margin:14px 0 6px}
    .reader h2{font-size:14px;margin:0 0 12px;color:var(--muted);font-weight:600}
    .text{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r16);
      padding:16px;
      line-height:1.7;
      font-size:15px;
      white-space:pre-wrap;
    }
    .reader-actions{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;
    }
    .toast{
      position:fixed;left:50%;bottom:88px;transform:translateX(-50%);
      background:rgba(17,19,24,.92);color:white;
      padding:10px 12px;border-radius:12px;
      font-size:13px;display:none;z-index:60;
    }

    /* Bottom nav */
    .bottom{
      position:fixed;left:0;right:0;bottom:0;z-index:20;
      border-top:1px solid var(--border);
      background:color-mix(in srgb, var(--bg) 84%, white 16%);
      backdrop-filter:saturate(180%) blur(10px);
    }
    .bottom-inner{
      max-width:980px;margin:0 auto;
      display:flex;justify-content:space-around;
      padding:10px 8px;
    }
    .tab{
      display:flex;flex-direction:column;gap:4px;align-items:center;
      font-size:11px;color:var(--muted);cursor:pointer;
      padding:6px 10px;border-radius:14px;
      user-select:none;
    }
    .tab.active{color:var(--text);background:var(--card);border:1px solid var(--border)}
    .tab b{font-size:12px}

    /* small helpers */
    .rightcol .card-b{padding-top:10px}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:10px 0}
    .kv span{color:var(--muted);font-size:12px}
    .kv b{font-size:13px}
    .note{font-size:12px;color:var(--muted);line-height:1.45}
    .linkbtn{
      display:inline-flex;align-items:center;gap:8px;
      text-decoration:none;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="appTitle">–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
          <p id="appSubtitle">–ß–∏—Ç–∞–ª–∫–∞ –≤–Ω—É—Ç—Ä–∏ Telegram</p>
        </div>
      </div>

      <div class="search" title="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é">
        üîé
        <input id="q" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, –∂–∞–Ω—Ä—ã, –æ–ø–∏—Å–∞–Ω–∏–µ‚Ä¶" />
      </div>

      <div class="pill" id="donateTop">
        ‚ù§Ô∏è <b>–î–æ–Ω–∞—Ç</b> <small>–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å</small>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <div class="hero card">
      <div class="welcome">
        <h3 id="welcomeTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
        <p id="welcomeText">
          –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –Ω–æ–≤–µ–ª–ª—ã –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã –∂–∞–Ω—Ä–æ–≤ –∏ –∑–∞–∫–ª–∞–¥–∫–∏.
        </p>
        <div class="cta">
          <button class="btn pink" id="openFirst">üìñ –û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—É—é –Ω–æ–≤–µ–ª–ª—É</button>
          <button class="btn secondary" id="showProfile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn secondary" id="showBookmarks">üîñ –ó–∞–∫–ª–∞–¥–∫–∏</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="leftcol">
        <div class="card">
          <div class="card-h">
            <div>
              <h2>–ö–∞—Ç–∞–ª–æ–≥</h2>
              <div class="sub" id="catalogSub">–§–∏–ª—å—Ç—Ä—É–π –ø–æ –∂–∞–Ω—Ä–∞–º –∏ –≤—ã–±–∏—Ä–∞–π, —á—Ç–æ —á–∏—Ç–∞—Ç—å</div>
            </div>
            <div class="sub" id="countInfo"></div>
          </div>
          <div class="card-b">
            <div class="filters" id="genreChips"></div>
            <div class="divider"></div>
            <div class="list" id="catalog"></div>
            <div class="empty" id="emptyCatalog" style="display:none;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∂–∞–Ω—Ä.</div>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="rightcol">
        <div class="card" id="panelProfile">
          <div class="card-h">
            <div>
              <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
              <div class="sub">–ß–∏—Ç–∞—Ç–µ–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
          </div>
          <div class="card-b">
            <div class="kv"><span>–ò–º—è</span><b id="pName">–ì–æ—Å—Ç—å</b></div>
            <div class="kv"><span>Telegram ID</span><b id="pId">‚Äî</b></div>
            <div class="kv"><span>–ó–∞–∫–ª–∞–¥–∫–∏</span><b id="pBookmarks">0</b></div>
            <div class="kv"><span>–õ–∞–π–∫–∏</span><b id="pLikes">0</b></div>
            <div class="divider"></div>
            <div class="note">
              –ó–∞–∫–ª–∞–¥–∫–∏ –∏ –ª–∞–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Ç–≤–æ—ë–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ. –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.
            </div>
          </div>
        </div>

        <div class="card" id="panelBookmarks" style="margin-top:14px;">
          <div class="card-h">
            <div>
              <h2>–ó–∞–∫–ª–∞–¥–∫–∏</h2>
              <div class="sub">–ü—Ä–æ–¥–æ–ª–∂–∞–π —á—Ç–µ–Ω–∏–µ</div>
            </div>
            <button class="mini" id="clearBookmarks">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="card-b" id="bmList"></div>
        </div>

        <div class="card" id="panelDonate" style="margin-top:14px;">
          <div class="card-h">
            <div>
              <h2>–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞–≤—Ç–æ—Ä–∞</h2>
              <div class="sub">–¥–æ–Ω–∞—Ç—ã / –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</div>
            </div>
          </div>
          <div class="card-b">
            <button class="btn pink" style="width:100%" id="donateBtn">‚ù§Ô∏è –î–æ–Ω–∞—Ç</button>
            <div class="note" style="margin-top:10px;">
              –¢—É—Ç –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ Boosty / –ÆMoney / Patreon –∏–ª–∏ Telegram Payments –ø–æ–∑–∂–µ.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reader -->
  <div class="reader" id="reader">
    <div class="reader-top">
      <div class="reader-top-inner">
        <button class="iconbtn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="flex:1;min-width:0">
          <div style="font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="rNovelTitle">‚Äî</div>
          <div style="font-size:12px;color:var(--muted)" id="rChapterTitle">‚Äî</div>
        </div>
        <button class="iconbtn" id="bmBtn">üîñ</button>
        <button class="iconbtn" id="likeBtn">‚ù§Ô∏è</button>
      </div>
    </div>
    <div class="reader-inner">
      <h1 id="rH1">‚Äî</h1>
      <h2 id="rH2">‚Äî</h2>
      <div class="text" id="rText"></div>

      <div class="reader-actions">
        <button class="btn secondary" id="prevCh">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
        <button class="btn" id="nextCh">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</button>
        <button class="btn pink" id="thanksBtn">‚ú® –°–∫–∞–∑–∞—Ç—å —Å–ø–∞—Å–∏–±–æ</button>
        <a class="btn secondary linkbtn" href="#" id="shareBtn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</a>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="bottom">
    <div class="bottom-inner">
      <div class="tab active" data-tab="catalog">üìö <b>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</b></div>
      <div class="tab" data-tab="search">üîé <b>–ü–æ–∏—Å–∫</b></div>
      <div class="tab" data-tab="bookmarks">üîñ <b>–ó–∞–∫–ª–∞–¥–∫–∏</b></div>
      <div class="tab" data-tab="profile">üë§ <b>–ü—Ä–æ—Ñ–∏–ª—å</b></div>
    </div>
  </div>

<script>
/**
 * –î–ê–ù–ù–´–ï (–∫–∞–∫ –º–µ–Ω—è—Ç—å):
 * - –î–æ–±–∞–≤–ª—è–π –Ω–æ–≤–µ–ª–ª—ã –≤ DATA.novels
 * - –£ –∫–∞–∂–¥–æ–π –Ω–æ–≤–µ–ª–ª—ã: id, title, cover (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ —Ñ–∞–π–ª), genres[], rating, views, description, chapters[]
 * - –£ –≥–ª–∞–≤—ã: id, title, text
 *
 * –û–±–ª–æ–∂–∫–∏ –º–æ–∂–Ω–æ:
 * - –∑–∞–ª–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —É–∫–∞–∑–∞—Ç—å "cover.jpg" / "covers/my.jpg"
 * - –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É https://...
 */
const DATA = {
  appTitle: "K-–ù–æ–≤–µ–ª–ª—ã",
  appSubtitle: "–í–µ–±-—á–∏—Ç–∞–ª–∫–∞ –≤ Telegram",
  donateUrl: "https://example.com/donate", // <-- –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É (Boosty/–ÆMoney/—Ç.–¥.)
  novels: [
    {
      id: "n1",
      title: "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã 1",
      cover: "cover.jpg", // –ø–æ–ª–æ–∂–∏ cover.jpg –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      genres: ["–†–æ–º–∞–Ω—Ç–∏–∫–∞", "–î—Ä–∞–º–∞"],
      rating: 4.8,
      views: 120,
      description: "–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –æ —á—ë–º –∏—Å—Ç–æ—Ä–∏—è –∏ –ø–æ—á–µ–º—É –µ—ë —Å—Ç–æ–∏—Ç —á–∏—Ç–∞—Ç—å.",
      chapters: [
        { id:"c1", title:"–ì–ª–∞–≤–∞ 1. –ù–∞—á–∞–ª–æ", text:"–¢–µ–∫—Å—Ç –≥–ª–∞–≤—ã 1...\n\n(—Å—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç)" },
        { id:"c2", title:"–ì–ª–∞–≤–∞ 2. –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ", text:"–¢–µ–∫—Å—Ç –≥–ª–∞–≤—ã 2...\n\n(—Å—é–¥–∞ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç)" },
      ]
    },
    {
      id: "n2",
      title: "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã 2",
      cover: "https://images.unsplash.com/photo-1526318472351-c75fcf070305?auto=format&fit=crop&w=1200&q=60",
      genres: ["–§—ç–Ω—Ç–µ–∑–∏", "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è"],
      rating: 4.6,
      views: 85,
      description: "–ï—â—ë –æ–¥–Ω–∞ –Ω–æ–≤–µ–ª–ª–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ.",
      chapters: [
        { id:"c1", title:"–ì–ª–∞–≤–∞ 1", text:"–¢–µ–∫—Å—Ç..." }
      ]
    },
    {
      id: "n3",
      title: "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã 3",
      cover: "https://images.unsplash.com/photo-1520975693411-b4e38f2b1a32?auto=format&fit=crop&w=1200&q=60",
      genres: ["–•–æ—Ä—Ä–æ—Ä", "–ú–∏—Å—Ç–∏–∫–∞"],
      rating: 4.1,
      views: 66,
      description: "–ú—Ä–∞—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π –º–∏—Å—Ç–∏–∫–∏.",
      chapters: [
        { id:"c1", title:"–ì–ª–∞–≤–∞ 1", text:"–¢–µ–∫—Å—Ç..." }
      ]
    },
  ]
};

// ---------- Telegram WebApp integration ----------
const tg = window.Telegram?.WebApp;
try { tg?.expand(); } catch(e){}

function getTgUser(){
  const u = tg?.initDataUnsafe?.user;
  if (!u) return { name: "–ì–æ—Å—Ç—å", id: "‚Äî" };
  const name = [u.first_name, u.last_name].filter(Boolean).join(" ").trim() || u.username || "–ß–∏—Ç–∞—Ç–µ–ª—å";
  return { name, id: String(u.id) };
}

// ---------- Storage ----------
const KEY = {
  bookmarks: "novel_app_bookmarks_v1",
  likes: "novel_app_likes_v1",
  thanks: "novel_app_thanks_v1",
  lastRead: "novel_app_lastread_v1",
};

function load(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

let BOOKMARKS = load(KEY.bookmarks, []); // [{novelId, chapterId, at: ts}]
let LIKES = load(KEY.likes, []);         // ["n1:c1", ...]
let THANKS = load(KEY.thanks, 0);
let LASTREAD = load(KEY.lastRead, null); // {novelId, chapterIndex}

// ---------- UI refs ----------
const $ = (id)=>document.getElementById(id);
const appTitle = $("appTitle");
const appSubtitle = $("appSubtitle");
const q = $("q");
const genreChips = $("genreChips");
const catalog = $("catalog");
const emptyCatalog = $("emptyCatalog");
const countInfo = $("countInfo");
const bmList = $("bmList");
const clearBookmarks = $("clearBookmarks");
const donateBtn = $("donateBtn");
const donateTop = $("donateTop");
const openFirst = $("openFirst");
const showProfile = $("showProfile");
const showBookmarks = $("showBookmarks");

const reader = $("reader");
const backBtn = $("backBtn");
const bmBtn = $("bmBtn");
const likeBtn = $("likeBtn");
const thanksBtn = $("thanksBtn");
const shareBtn = $("shareBtn");
const prevCh = $("prevCh");
const nextCh = $("nextCh");

const rNovelTitle = $("rNovelTitle");
const rChapterTitle = $("rChapterTitle");
const rH1 = $("rH1");
const rH2 = $("rH2");
const rText = $("rText");
const toast = $("toast");

const pName = $("pName");
const pId = $("pId");
const pBookmarks = $("pBookmarks");
const pLikes = $("pLikes");

// ---------- State ----------
let selectedGenre = "–í—Å–µ";
let query = "";
let current = null; // {novelId, chapterIndex}

// ---------- Helpers ----------
function showToast(text){
  toast.textContent = text;
  toast.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.style.display="none", 1500);
}

function getAllGenres(){
  const set = new Set();
  DATA.novels.forEach(n => (n.genres||[]).forEach(g => set.add(g)));
  return ["–í—Å–µ", ...Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'))];
}

function isBookmarked(novelId, chapterId){
  return BOOKMARKS.some(b => b.novelId===novelId && b.chapterId===chapterId);
}
function toggleBookmark(novelId, chapterId){
  if (isBookmarked(novelId, chapterId)){
    BOOKMARKS = BOOKMARKS.filter(b => !(b.novelId===novelId && b.chapterId===chapterId));
    save(KEY.bookmarks, BOOKMARKS);
    showToast("–£–±—Ä–∞–Ω–æ –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫");
  } else {
    BOOKMARKS.unshift({novelId, chapterId, at: Date.now()});
    // –æ–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑–º–µ—Ä
    BOOKMARKS = BOOKMARKS.slice(0, 200);
    save(KEY.bookmarks, BOOKMARKS);
    showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∑–∞–∫–ª–∞–¥–∫–∏");
  }
  renderSidePanels();
  renderReaderButtons();
}

function likeKey(novelId, chapterId){ return `${novelId}:${chapterId}`; }
function isLiked(novelId, chapterId){ return LIKES.includes(likeKey(novelId, chapterId)); }
function toggleLike(novelId, chapterId){
  const k = likeKey(novelId, chapterId);
  if (LIKES.includes(k)){
    LIKES = LIKES.filter(x=>x!==k);
    save(KEY.likes, LIKES);
    showToast("–õ–∞–π–∫ —É–±—Ä–∞–Ω");
  } else {
    LIKES.push(k);
    save(KEY.likes, LIKES);
    showToast("‚ù§Ô∏è –°–ø–∞—Å–∏–±–æ!");
  }
  renderSidePanels();
  renderReaderButtons();
}

function renderGenres(){
  const genres = getAllGenres();
  genreChips.innerHTML = "";
  genres.forEach(g=>{
    const b = document.createElement("button");
    b.className = "chip" + (g===selectedGenre ? " active" : "");
    b.textContent = g;
    b.onclick = ()=>{
      selectedGenre = g;
      renderGenres();
      renderCatalog();
    };
    genreChips.appendChild(b);
  });
}

function matchesNovel(n){
  const ql = query.trim().toLowerCase();
  const genreOk = (selectedGenre==="–í—Å–µ") || (n.genres||[]).includes(selectedGenre);
  if (!genreOk) return false;
  if (!ql) return true;
  const hay = [
    n.title, n.description, (n.genres||[]).join(" ")
  ].join(" ").toLowerCase();
  return hay.includes(ql);
}

function novelCard(n){
  const el = document.createElement("div");
  el.className = "novel";
  el.innerHTML = `
    <div class="cover">
      <img src="${escapeHtmlAttr(n.cover)}" alt="–û–±–ª–æ–∂–∫–∞">
      <div class="badge">‚òÖ ${n.rating ?? "‚Äî"} ¬∑ üëÅ ${n.views ?? 0}</div>
    </div>
    <div class="novel-b">
      <div class="title">${escapeHtml(n.title)}</div>
      <div class="meta">
        ${(n.genres||[]).map(g=>`<span>#${escapeHtml(g)}</span>`).join("")}
      </div>
      <div class="row">
        <button class="mini primary">–ß–∏—Ç–∞—Ç—å</button>
        <button class="mini" data-info>–û –Ω–æ–≤–µ–ª–ª–µ</button>
      </div>
    </div>
  `;
  el.onclick = (e)=>{
    const info = e.target?.getAttribute?.("data-info") !== null;
    if (info){
      showNovelAbout(n);
    } else {
      openReader(n.id, 0);
    }
  };
  return el;
}

function renderCatalog(){
  const items = DATA.novels.filter(matchesNovel);
  catalog.innerHTML = "";
  items.forEach(n=>catalog.appendChild(novelCard(n)));
  emptyCatalog.style.display = items.length ? "none" : "block";
  countInfo.textContent = `${items.length}/${DATA.novels.length}`;
}

function showNovelAbout(n){
  const genres = (n.genres||[]).map(g=>`#${g}`).join(" ¬∑ ");
  const text = `${n.title}\n\n${n.description}\n\n–ñ–∞–Ω—Ä—ã: ${genres || "‚Äî"}\n–ì–ª–∞–≤: ${(n.chapters||[]).length}`;
  if (tg?.showPopup){
    tg.showPopup({
      title: "–û –Ω–æ–≤–µ–ª–ª–µ",
      message: text,
      buttons: [
        {id:"read", type:"default", text:"–ß–∏—Ç–∞—Ç—å"},
        {id:"close", type:"cancel", text:"–ó–∞–∫—Ä—ã—Ç—å"},
      ]
    }, (id)=>{
      if (id==="read") openReader(n.id, 0);
    });
  } else {
    alert(text);
  }
}

function renderSidePanels(){
  // profile
  const u = getTgUser();
  pName.textContent = u.name;
  pId.textContent = u.id;
  pBookmarks.textContent = String(BOOKMARKS.length);
  pLikes.textContent = String(LIKES.length);

  // bookmarks list
  bmList.innerHTML = "";
  if (!BOOKMARKS.length){
    bmList.innerHTML = `<div class="empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–∫—Ä–æ–π –≥–ª–∞–≤—É –∏ –Ω–∞–∂–º–∏ üîñ</div>`;
    return;
  }
  BOOKMARKS.slice(0, 12).forEach(b=>{
    const n = DATA.novels.find(x=>x.id===b.novelId);
    if (!n) return;
    const chIndex = (n.chapters||[]).findIndex(c=>c.id===b.chapterId);
    const ch = (n.chapters||[])[chIndex];
    if (!ch) return;

    const row = document.createElement("div");
    row.className = "novel";
    row.style.cursor="pointer";
    row.innerHTML = `
      <div class="novel-b">
        <div class="title">${escapeHtml(n.title)}</div>
        <div class="meta"><span>${escapeHtml(ch.title)}</span></div>
        <div class="row">
          <button class="mini primary">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="mini">–£–±—Ä–∞—Ç—å</button>
        </div>
      </div>
    `;
    row.onclick = (e)=>{
      const btnText = (e.target?.textContent||"").trim();
      if (btnText==="–£–±—Ä–∞—Ç—å"){
        toggleBookmark(b.novelId, b.chapterId);
      } else {
        openReader(b.novelId, chIndex);
      }
    };
    bmList.appendChild(row);
  });
}

function openReader(novelId, chapterIndex){
  const n = DATA.novels.find(x=>x.id===novelId);
  if (!n) return;
  const ch = (n.chapters||[])[chapterIndex];
  if (!ch) return;

  current = { novelId, chapterIndex };
  LASTREAD = { novelId, chapterIndex };
  save(KEY.lastRead, LASTREAD);

  rNovelTitle.textContent = n.title;
  rChapterTitle.textContent = `–ì–ª–∞–≤–∞ ${chapterIndex+1} –∏–∑ ${(n.chapters||[]).length}`;
  rH1.textContent = ch.title;
  rH2.textContent = (n.genres||[]).map(g=>`#${g}`).join(" ¬∑ ");
  rText.textContent = ch.text || "";

  renderReaderButtons();

  reader.style.display = "block";
  document.body.style.overflow="hidden";

  // share link (–ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç)
  shareBtn.onclick = (e)=>{
    e.preventDefault();
    const url = location.href.split("#")[0];
    const shareText = `${n.title} ‚Äî ${ch.title}`;
    const msg = `${shareText}\n${url}`;
    if (tg?.openTelegramLink){
      tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(shareText)}`);
    } else {
      navigator.clipboard?.writeText(msg);
      showToast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    }
  };

  prevCh.onclick = ()=>openReader(novelId, Math.max(0, chapterIndex-1));
  nextCh.onclick = ()=>openReader(novelId, Math.min((n.chapters||[]).length-1, chapterIndex+1));

  prevCh.disabled = chapterIndex===0;
  nextCh.disabled = chapterIndex===((n.chapters||[]).length-1);
}

function closeReader(){
  reader.style.display = "none";
  document.body.style.overflow="";
}

function renderReaderButtons(){
  if (!current) return;
  const n = DATA.novels.find(x=>x.id===current.novelId);
  const ch = n?.chapters?.[current.chapterIndex];
  if (!n || !ch) return;

  bmBtn.textContent = isBookmarked(n.id, ch.id) ? "üîñ‚úì" : "üîñ";
  likeBtn.textContent = isLiked(n.id, ch.id) ? "‚ù§Ô∏è‚úì" : "‚ù§Ô∏è";

  bmBtn.onclick = ()=>toggleBookmark(n.id, ch.id);
  likeBtn.onclick = ()=>toggleLike(n.id, ch.id);

  thanksBtn.onclick = ()=>{
    THANKS = (THANKS||0) + 1;
    save(KEY.thanks, THANKS);
    showToast("‚ú® –°–ø–∞—Å–∏–±–æ –ø—Ä–∏–Ω—è—Ç–æ!");
  };
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeHtmlAttr(s){ return escapeHtml(s).replaceAll("`","&#096;"); }

// ---------- Tabs ----------
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===name);
  });

  if (name==="catalog"){
    // nothing special
    document.getElementById("panelProfile").scrollIntoView({behavior:"smooth", block:"nearest"});
  }
  if (name==="search"){
    q.focus();
  }
  if (name==="bookmarks"){
    document.getElementById("panelBookmarks").scrollIntoView({behavior:"smooth", block:"start"});
  }
  if (name==="profile"){
    document.getElementById("panelProfile").scrollIntoView({behavior:"smooth", block:"start"});
  }
}

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick = ()=>setTab(t.dataset.tab);
});

// ---------- Wire up ----------
function init(){
  // Titles
  appTitle.textContent = DATA.appTitle || "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞";
  appSubtitle.textContent = DATA.appSubtitle || "";
  document.title = DATA.appTitle || document.title;

  // donate handlers
  function goDonate(){
    const url = DATA.donateUrl;
    if (!url || url==="https://example.com/donate"){
      showToast("–°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å —Å–≤–æ—é —Å—Å—ã–ª–∫—É –¥–æ–Ω–∞—Ç–∞ –≤ donateUrl");
      return;
    }
    if (tg?.openLink) tg.openLink(url);
    else window.open(url, "_blank");
  }
  donateBtn.onclick = goDonate;
  donateTop.onclick = goDonate;

  // search
  q.addEventListener("input", ()=>{
    query = q.value;
    renderCatalog();
  });

  // panels buttons
  showProfile.onclick = ()=>setTab("profile");
  showBookmarks.onclick = ()=>setTab("bookmarks");

  // open first / last read
  openFirst.onclick = ()=>{
    if (LASTREAD){
      openReader(LASTREAD.novelId, LASTREAD.chapterIndex);
    } else if (DATA.novels[0]){
      openReader(DATA.novels[0].id, 0);
    }
  };

  // bookmarks clear
  clearBookmarks.onclick = ()=>{
    BOOKMARKS = [];
    save(KEY.bookmarks, BOOKMARKS);
    renderSidePanels();
    showToast("–ó–∞–∫–ª–∞–¥–∫–∏ –æ—á–∏—â–µ–Ω—ã");
  };

  // reader close
  backBtn.onclick = closeReader;

  // profile data
  renderSidePanels();

  // genres + catalog
  renderGenres();
  renderCatalog();

  // Telegram theme hint (–Ω–µ –æ–±—è–∑.)
  try{
    if (tg?.themeParams?.bg_color){
      // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ-–ø–æ–¥—Å—Ç—Ä–æ–π–∫—É –ø–æ–∑–∂–µ
    }
  }catch(e){}
}
init();
</script>
</body>
</html>
